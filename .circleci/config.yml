# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-image-arm64:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: arm.medium

    environment:
      TZ: "Asia/Tokyo"

    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - run:
          name: "Config"
          command: |
            # configs
            echo 'export DOCKER_TAG_SUFFIX="_arm64"' >> "$BASH_ENV"
            echo 'export DOCKER_PLATFORM="linux/arm64"' >> "$BASH_ENV"

            # to multi-arch build so we dont include HOUR in tag name
            echo 'export DOCKER_TAG="`date '+%Y%m%d'`${DOCKER_TAG_SUFFIX}"' >> "$BASH_ENV"
            echo 'export DOCKER_TAG_LATEST="latest"' >> "$BASH_ENV"
            echo 'export DOCKERHUB_IMAGENAME="yakumosaki/docker-multiarch-test"' >> "$BASH_ENV"
      - checkout
      - run: ls -l
      - run:
          name: "Build"
          command: |
            ARCH=`uname -m`
            echo $ARCH
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}

            docker buildx build --platform ${DOCKER_PLATFORM} -t $DOCKERHUB_IMAGENAME:$DOCKER_TAG . --push
            docker tag $DOCKERHUB_IMAGENAME:$DOCKER_TAG $DOCKERHUB_IMAGENAME:$DOCKER_TAG_LATEST
      - run:
          name: "Push"
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
            #docker push $DOCKERHUB_IMAGENAME:$DOCKER_TAG
            docker push $DOCKERHUB_IMAGENAME:$DOCKER_TAG_LATEST

  build-image-amd64:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: medium

    environment:
      TZ: "Asia/Tokyo"

    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - run:
          name: "Determine tag name"
          command: |
            # configs
            echo 'export DOCKER_TAG_SUFFIX="_amd64"' >> "$BASH_ENV"
            echo 'export DOCKER_PLATFORM="linux/amd64"' >> "$BASH_ENV"

            # to multi-arch build so we dont include HOUR in tag name
            echo 'export DOCKER_TAG="`date '+%Y%m%d'`${DOCKER_TAG_SUFFIX}"' >> "$BASH_ENV"
            echo 'export DOCKER_TAG_LATEST="latest"' >> "$BASH_ENV"
            echo 'export DOCKERHUB_IMAGENAME="yakumosaki/docker-multiarch-test"' >> "$BASH_ENV"

      - checkout
      - run: ls -l
      - run:
          name: "Build"
          command: |
            ARCH=`uname -m`
            echo $ARCH
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}

            docker buildx build --platform ${DOCKER_PLATFORM} -t $DOCKERHUB_IMAGENAME:$DOCKER_TAG . --push
            docker tag $DOCKERHUB_IMAGENAME:$DOCKER_TAG $DOCKERHUB_IMAGENAME:$DOCKER_TAG_LATEST
      - run:
          name: "Push"
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
            #docker push $DOCKERHUB_IMAGENAME:$DOCKER_TAG
            docker push $DOCKERHUB_IMAGENAME:$DOCKER_TAG_LATEST

  push-latest-tag:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: medium

    environment:
      TZ: "Asia/Tokyo"

    steps:
      - run:
          name: "latest"
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
            docker manifest create yakumosaki/docker-multiarch-test:latest \
                                  yakumosaki/docker-multiarch-test:latest_arm64 \
                                  yakumosaki/docker-multiarch-test:latest_amd64
            docker manifest push yakumosaki/docker-multiarch-test:latest

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-and-push-glitch-soc:
    jobs:
      - build-image-arm64:
          context: DOCKER_USER
      - build-image-amd64:
          context: DOCKER_USER
      - push-latest-tag:
          requires:
            - build-image-arm64
            - build-image-amd64
          context: DOCKER_USER
        
